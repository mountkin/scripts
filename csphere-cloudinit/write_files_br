- path: /etc/csphere/br.sh
  permissions: 0744
  owner: root
  content: |
    #!/bin/sh
    set -ex

    dev=
    gw=$(route -n|awk '{ if ($1 == "0.0.0.0")  print $2}')
    echo "got default gateway: $gw"
    for  card in  $(lshw -class network|grep 'logical name'|awk -F ':' '{print $2}');do
       echo "now config : $card in promisc mode"
       ifconfig  $card  promisc 
       echo "now create one new bridge, and add ${card} to it"
       ip=$(ifconfig $card |grep -w 'inet' |awk '{print $2}')
       mask=$(ifconfig $card |grep -w 'inet' |awk '{print $4}')
       echo "got $card,  ip: $ip , mask: $mask"
       brctl  addbr  br${card}
       brctl  addif  br${card}  ${card}
       ip addr  flush dev   $card
       ifconfig  br${card}  $ip  netmask $mask
       dev=br${card}
    done
    route add default gw $gw $dev
