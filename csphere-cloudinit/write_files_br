- path: /etc/csphere/br.sh
  permissions: 0744
  owner: root
  content: |
    #!/bin/sh
    set -ex

    dev=
    dockerenv="/run/flannel_docker_opts.env"
    gw=$(route -n|awk '($1=="0.0.0.0" && $4=="UG"){print $2;exit}')
    echo "got default gateway: $gw"
    for  card in  $(lshw -class network|grep 'logical name'|awk -F ':' '{print $2}');do
       echo "now config : $card in promisc mode"
       ifconfig  $card  promisc 
       echo "now create one new bridge, and add ${card} to it"
       ip=$(ifconfig $card |grep -w 'inet' |awk '{print $2}')
       mask=$(ifconfig $card |grep -w 'inet' |awk '{print $4}')
       echo "got $card,  ip: $ip , mask: $mask"
       if [ -n "${ip}" -a -n "${mask}" ]; then
           if ! (brctl show | grep -q "br${card}"); then
               brctl  addbr  br${card}
               brctl  addif  br${card}  ${card}
               ip addr  flush dev   $card
               ifconfig  br${card}  $ip  netmask $mask
           else
               echo "bridge br${card} already exists, do nothing"
           fi
       else
           echo "ip or mask null, skip"
           continue
       fi
       # remove me, use last interface bridge, will fix it later
       dev=br${card}
    done
    route add default gw $gw $dev || true
    if [ -n "${dev}" ]; then
        echo -e "BRIDGE=${dev}" > ${dockerenv}
    fi
